# syntax=docker/dockerfile:1.7
# ZenithSpace Frontend — RAM-optimized build
# All heavy I/O (pnpm install + turbo build) happens in tmpfs to avoid HDD bottleneck

FROM alpine/git AS cloner
WORKDIR /repo
ARG CACHEBUST=1
RUN git clone --depth=1 --branch main https://github.com/AdeChrysler/zenithspace-plane.git .

FROM node:22-alpine AS base
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

# *****************************************************************************
# STAGE 1: Prune monorepo for web app only
# *****************************************************************************
FROM base AS pruner
RUN apk add --no-cache libc6-compat
WORKDIR /app
ARG TURBO_VERSION=2.6.3
RUN corepack enable pnpm && pnpm add -g turbo@${TURBO_VERSION}
COPY --from=cloner /repo .
RUN turbo prune --scope=web --docker

# *****************************************************************************
# STAGE 2: Install + Build entirely in tmpfs (RAM)
# The pnpm install (linking 1500+ packages) and turbo build are 99% of build
# time on HDD. By running in tmpfs, we go from 35min → ~2min.
# Only the final COPY of build output touches disk.
# *****************************************************************************
FROM base AS installer
RUN apk add --no-cache libc6-compat
WORKDIR /staging

# Copy pruned sources to a staging area (small, fast)
COPY --from=cloner /repo/.gitignore .gitignore
COPY --from=pruner /app/out/json/ .
COPY --from=pruner /app/out/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=pruner /app/out/full/ .
COPY --from=cloner /repo/turbo.json turbo.json
RUN corepack enable pnpm

# Single mega-RUN: fetch, install, build — all in tmpfs
# 1. Copy staging to tmpfs (/ram)
# 2. pnpm fetch + install in RAM (no disk I/O for node_modules)
# 3. Vite/turbo build in RAM
# 4. Copy only the final build output (~10MB) back to disk layer
RUN --mount=type=tmpfs,target=/ram,size=8G \
    cp -a /staging/. /ram/ && \
    cd /ram && \
    pnpm fetch && \
    CI=true pnpm install --offline --frozen-lockfile && \
    NEXT_TELEMETRY_DISABLED=1 TURBO_TELEMETRY_DISABLED=1 \
    pnpm turbo run build --filter=web && \
    mkdir -p /output && \
    cp -a /ram/apps/web/build/client/. /output/

# *****************************************************************************
# STAGE 3: Serve with nginx (tiny final image)
# *****************************************************************************
FROM nginx:1.27-alpine AS production

COPY --from=cloner /repo/apps/web/nginx/nginx.conf /etc/nginx/nginx.conf
COPY --from=installer /output /usr/share/nginx/html

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD curl -fsS http://127.0.0.1:3000/ >/dev/null || exit 1

CMD ["nginx", "-g", "daemon off;"]
